<!DOCTYPE html>

<html>
<head>
	<meta name="encoding" content="utf-8" />

<script src="utils.js"></script>
<script type="text/javascript">

var background = chrome.extension.getBackgroundPage();
var statuses = background.statuses;
console.log(statuses);

function popupClosed() {
	background.popup_ui_update = undefined;
}

function updateTargetDiv(target, message) {
	if (!message) {
		var message = 'Not synchronized.';
		if (target.enabled) {
			if (target.status == statuses.READY) {
				message = 'Synchronized.';
			} else if (target.status == statuses.DOWNLOADING) {
				message = 'Downloading...';
			} else if (target.status == statuses.MERGING) {
				message = 'Syncing...';
			} else if (target.status == statuses.UPLOADING) {
				message = 'Uploading...';
				var queue = target.queue || target.r_queue;
				if (queue) {
					message = 'Uploading ('+queue.length+' left)...';
				}
			} else {
				message = 'Enabled, but unknown status (BUG! status='+target.status+')';
			}
		}
	}
	document.getElementById(target.shortname+'_status').innerText = message;
}

// TODO change this to a more fine-grained system.
function updatePopup() {
	var target;
	for (var i=0; target=background.remotes[i]; i++) {
		updateTargetDiv(target);
		document.getElementById(target.shortname+'_button_stop').disabled = !(target.enabled && !target.status);
	}
}

chrome.extension.onRequest.addListener(
		function (request, sender, sendResponse) {
			if (request.action != 'updateUi') return; // not for me
			if (request.target) {
				// update single target
				updateTargetDiv(background.remotes_by_name[request.target]);
			} else {
				// update whole popup
				updatePopup();
			}
			sendResponse({});
		});

</script>
<style>
body {
	text-align: right;
}
.target {
	border: 5px #aaaaff outset;
	background: #ccccff;
	white-space: nowrap;
	margin: 0.3em;
	padding: 0.3em;
}
</style>
</head>

<body onload="updatePopup();" onunload="popupClosed();">

<div id="target_gbm" class="target">
	<strong>Google Bookmarks:</strong> <span id="gbm_status">Loading...</span><br />
	<button id='gbm_button_start' onclick="background.gbm.start();" title="Start synchronizing with Google Bookmarks. Will continue to sync, even after a restart.">(Re)synchronize</button>
	<button id='gbm_button_stop' onclick="background.gbm.disable();" title="Stop synchronizing with Google Bookmarks">Disable</button>
</div>

<div id="target_opl" class="target">
	<strong>Opera Link:</strong> <span id="opl_status">Loading...</span><br />
	<button id="opl_button_start" onclick="background.opl.start();" title="Start synchronizing with Opera Link">(Re)synchronize</button>
	<button id="opl_button_stop" onclick="background.opl.stop();" title="Stop synchronizing with Opera Link">Disable</button>
</div>

</body>

</html>
