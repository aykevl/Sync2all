<!DOCTYPE html>

<html>
<head>
	<meta name="encoding" content="utf-8" />

<script src="utils.js"></script>
<script type="text/javascript">
// <!--
// if browser is firefox
if (this.Components && Components.classes) {
	var Sync2allService = Components
		.classes['@github.com/sync2all;1']
		.getService(Components.interfaces.nsISync2allService).wrappedJSObject;
} else {
	// for other browsers
	Sync2allService = this;
	document.write('<script src="/chrome/content/globals.js"></script>');
}
//-->
</script>
<script type="text/javascript">


var Sync2all = {};
Sync2all.popup = {};
// send signal that this popup has been closed
Sync2all.popup.popupClosed = function () {
	// this function is somehow not called (?). FIXME: make it work.
	Sync2all.popup.sendMessage({action: 'popupClosed'});
}

Sync2all.popup.updateTargetDiv = function (target) {
	var message = 'Not synchronized.';
	if (target.enabled) {
		if (target.status == Sync2allService.statuses.READY) {
			message = 'Synchronized.';
		} else if (target.status == Sync2allService.statuses.DOWNLOADING) {
			message = 'Downloading...';
		} else if (target.status == Sync2allService.statuses.MERGING) {
			message = 'Syncing...';
		} else if (target.status == Sync2allService.statuses.UPLOADING) {
			message = 'Uploading ('+target.left+' left)...';
		} else {
			message = 'Enabled, but unknown status (BUG! status='+target.status+')';
		}
	}
	document.getElementById(target.shortname+'_status').innerText = message;
	document.getElementById(target.shortname+'_button_stop').disabled = (!target.enabled || target.status)?true:false;
	document.getElementById(target.shortname+'_button_start').disabled = (target.enabled && target.status)?true:false;
}

Sync2all.popup.onMessage = function (request, sender, sendResponse) {
	if (!request) return;
	console.log(request);
	if (request.action != 'updateUi') return; // not for me
	Sync2all.popup.updateTargetDiv(request);
	sendResponse(undefined);
}

Sync2all.popup.init_popup = function () {
	/* Detect browser and do browser-specific initialisation */

	if (Sync2allService.browser.name == 'chrome') {
		// Chrome initialisation data
		chrome.extension.onRequest.addListener(Sync2all.popup.onMessage);
		chrome.extension.sendRequest({action: 'popupCreated'});

	} else if (Sync2allService.browser.name == 'opera') {
		// Opera initialisation
		var bgPort;
		opera.extension.onmessage = function (x) {
			bgPort = event.source;
		};
	} else if (Sync2allService.browser.name == 'firefox') {
	}
}

Sync2all.popup.sendMessage = function (msg) {
	if (Sync2allService.browser.name == 'chrome') {
		chrome.extension.sendRequest(msg);
	}
}


</script>
<style>
body {
	text-align: right;
	background-color: white;
}

/* TODO: better style */
.target {
	border: 5px #aaaaff outset;
	background: #ccccff;
	white-space: nowrap;
	margin: 0.3em;
	padding: 0.3em;
}
</style>
</head>

<body onload="Sync2all.popup.init_popup();" onUnload="Sync2all.popup.popupClosed();">

<div id="target_gbm" class="target">
	<strong>Google Bookmarks:</strong> <span id="gbm_status">Loading...</span><br />
	<button id='gbm_button_start' onclick="Sync2all.popup.sendMessage({action: 'gbm_start'});" title="Start synchronizing with Google Bookmarks. Will continue to sync, even after a restart.">(Re)synchronize</button>
	<button id='gbm_button_stop' onclick="Sync2all.popup.sendMessage({action: 'gbm_stop'});" title="Stop synchronizing with Google Bookmarks">Disable</button>
</div>

<div id="target_opl" class="target">
	<strong>Opera Link:</strong> <span id="opl_status">Loading...</span><br />
	<button id="opl_button_start" onclick="Sync2all.popup.sendMessage({action: 'opl_start'});" title="Start synchronizing with Opera Link">(Re)synchronize</button>
	<button id="opl_button_stop" onclick="Sync2all.popup.sendMessage({action: 'opl_stop'});" title="Stop synchronizing with Opera Link">Disable</button>
</div>

</body>

</html>
